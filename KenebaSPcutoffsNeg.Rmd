---
title: "Keneba Big Study - Seropositivity Cutoffs - One negative population"
output:
  pdf_document: default
  html_notebook: default
  word_document: default
---

First set working directory in the console:  
setwd("/Users/Katie/Desktop/R files from work/Keneba main results/Keneba Analysis/KenebaSPcutoffs")

For all antigens, establish seropositive, negative, and possibly indeterminate populations.

Select which category the antigen belongs to based on histogram and understanding of the antigen/pathogen.
1.	Single population – seronegative 
2.	Single population – seropositive 
3.	Two populations

For single populations, remove tails and use mean +/- xSD of normal distribution to set cutoff.

For dual populations, use FMM or k-means clustering to determine populations, then use probability classification function to place samples into negative, positive, or indeterminate groups.

```{r setup}
library(gcookbook)
library(dplyr)

load("KenebaAnalysis_IgG_v1.RData")
targetupdate <- read.csv("KenebaAntigenKeyv6.csv")
```

1. Identify seronegative populations and set cutoffs.  
IgG first - listed as "neg" in antigen key v6.  
```{r}
burritos2 <- burritos[,(ncol(target_meta2.df)+1):ncol(burritos)]
rownames(burritos2) <- burritos$Name

burritos3 <- merge(targetupdate, burritos2, by.y = "row.names", by.x = "Name")

negants <- filter(burritos3, SP_group_IgG == "neg")
rownames(negants) <- make.names(negants$Name)
negantnames <- sort(as.character(row.names(negants)))
```

Set up stuff which will be used for all antigens.
```{r}
negcutoffs <- as.data.frame(matrix(ncol= 4, nrow = length(negantnames))) 
colnames(negcutoffs) <- c("Name", "plus2SD", "plus3SD", "plus4SD")

tails <- as.data.frame(matrix(ncol = 3, nrow = length(negantnames)))
colnames(tails) <- c("Name","ltail", "rtail")
tails$Name <- negantnames
```

Go through negative antigens one by one and   
1. Identify negative population (remove tails) based on histogram.  
2. Assuming normal distribution, calculate cutoff as mean plus 2, 3, 4 times SD.  
3. Plot histogram showing all data, cutoffs added (2, 3, and 4SD), and normal distribution curve for subsetted data added.  
```{r}

#Manually set set limits of data based on histogram for all antigens by 
#exporting the tails data frame as a csv file and typing into it, then 
#reading it back in. Make sure not to overwrite it when knitting this document. 
#write.csv(tails, file = "negativetails.csv")

tailsdone <- read.csv("negativetails.csv")

#In a for loop, calculate cutoffs for all antigens and plot distribution 
#and cutoffs on histogram

for(i in 1:length(negantnames)){
#Select antigen
antigen <- negantnames[i]

#set left and right tail cutoffs
ltail <- tailsdone[i,2]
rtail <- tailsdone[i,3]

#subset data for this antigen
singleant <- c(as.matrix(negants[i, (ncol(targetupdate)+1):ncol(negants)]))
subant <- singleant[singleant <= rtail & singleant >= ltail]

#Assuming normal distribution, calculate cutoffs 
negcutoffs[i,1] <- antigen
negcutoffs[i,2] <- mean(subant, na.rm = TRUE) + 2*sd(subant, na.rm = TRUE)
negcutoffs[i,3] <- mean(subant, na.rm = TRUE) + 3*sd(subant, na.rm = TRUE)
negcutoffs[i,4] <- mean(subant, na.rm = TRUE) + 4*sd(subant, na.rm = TRUE)

#Plot data 
#plot_x <- seq(ltail,rtail,by = 0.1)

print({hist(singleant, prob = TRUE, breaks=50, main = antigen, 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,8),  ylim=c(0,2.5))
curve(dnorm(x, mean(subant, na.rm = TRUE), sd(subant, na.rm = TRUE)), 
  add=TRUE, col="darkblue", lwd=2)
abline(v = negcutoffs[i,2:4], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)})

}

#Display all of the cutoffs
negcutoffs

#save the cutoffs in an R object to be imported later 
save(negcutoffs, file=paste0(study,"_negcutoffs"))

```

