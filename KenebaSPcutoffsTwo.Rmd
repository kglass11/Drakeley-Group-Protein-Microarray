---
title: "Keneba Big Study - Seropositivity Cutoffs - Two or Three Populations - IgG"
output:
  pdf_document: default
  html_notebook: default
  word_document: default
---
  
For all antigens, establish seropositive, negative, and possibly indeterminate populations.  
    
Select which category the antigen belongs to based on histogram and understanding of the antigen/pathogen.  
1.	Single population – seronegative   
2.	Single population – seropositive  
**3.	Two (or three) populations**  
  
**For multiple populations, run 2 component (or 3 component) finite mixture model(FMM) using normalmixEM function, part of mixtools package to determine populations. Then use probability classification function to assign cutoffs for seronegativity and seropositivity as the point where the probability of being in the negative or positive population reaches 0.9. The samples in between these cutoffs are indeterminate.**

This method is previously published by our group: Current mathematical models for analyzing anti-malarial antibody data with an eye to malaria elimination and eradication. Nuno Sepulveda, Gillian Stresman, Michael T White, and Chris J Drakeley. Journal of Immunology Research, 2015.  
   
Antigens identified as three populations will be treated as dual populations (seronegative and seropositive) for all initial analysis.  
  
Notes regarding the method:    
a. The probability classification function may fail to determine a cutoff for seronegativity or seropositivity.  This means that there is no point in the data for which there is a greater than 90% (that's the cutoff I'm choosing, based on Nuno and Gillian's paper) probability that a sample is in that population (negative, positive or both).   
b. The FMM results are sometimes inconsistent and there are multiple solutions. I am getting around this problem by setting max iterations to 10K, running the FMM ten times, then selecting the best solution for each antigen and putting in those results as initial values (see FMM strategy below for further detail).  
c. Potential Alternatives:       
  1. Go back to making sure the negative population is well identified or the positive population well identified by FMM and then doing the mean +/- sd thing again.  
  2. For the antigens for which the seroreactivity in the UK population should be and looks negative (such as malarial antigens), consider using the UK negative population rather than FMM.     
  
**First set working directory in the console:  
setwd("/Users/Katie/Desktop/R files from work/Keneba main results/Keneba Analysis/KenebaSPcutoffs")**
  
1. Set up things needed for the whole script, including defining probability classification functions - these work for k=2 or k=3 in FMM.
```{r setup}
library(mixtools)
library(gcookbook)
library(gplots)
library(ggplot2)
library(dplyr)
library(reshape2)

#import relevant data
load("KenebaAnalysis_IgG_v1.RData")
targetupdate <- read.csv("KenebaAntigenKeyv7.csv")

#define probability classification functions
f<-function(x,prob,lambda,mu,sigma,k,k1){
  lista<-order(mu)
  
  lambda<-lambda[lista]
  mu<-mu[lista]	
  sigma<-sigma[lista]	
  
  p<-vector('numeric',k)
  
  for(i in 1:k)p[i]<-lambda[i]*dnorm(x,mu[i],sigma[i])
  
  prob-sum(p[1:k1])/sum(p)  
}

f2<-function(x,prob,lambda,mu,sigma,k,k1){
  lista<-order(mu)
  
  lambda<-lambda[lista]
  mu<-mu[lista]	
  sigma<-sigma[lista]	
  
  p<-vector('numeric',k)
  
  for(i in 1:k)p[i]<-lambda[i]*dnorm(x,mu[i],sigma[i])
  
  prob-sum(p[k1:k])/sum(p)
}

```

2. Identify antigens with multiple populations.   
IgG first - listed as "two" or "three" in antigen key v7.  
```{r}
burritos2 <- burritos[,(ncol(target_meta2.df)+1):ncol(burritos)]
rownames(burritos2) <- burritos$Name

burritos3 <- merge(targetupdate, burritos2, by.y = "row.names", by.x = "Name")

multants <- filter(burritos3, SP_group_IgG == "two" | SP_group_IgG == "three")
rownames(multants) <- make.names(multants$Name)
multantnames <- rownames(multants)
```

3. Set up data frames which will be used to store information for all antigens. Save a cutoff below which is negative,  a cutoff above which is positive. Indeterminate samples will be in the middle of those two cutoffs. Use greater than or equal and less than or equal to the cutoff. Also save the seroprevalence positive and negative and indeterminate for all antigens. 

```{r}
multcutoffs <- as.data.frame(matrix(ncol = 6, nrow = length(multantnames))) 
colnames(multcutoffs) <- c("Name", "cutoff.neg", "cutoff.pos", "prev.neg", "prev.pos", "prev.indet")
multcutoffs$Name <- multantnames
```

4.FMM - Do the following for each antigen one by one:    
-- Run fmm and probability classification function (and plot this) and store cutoffs. On this plot, the blue line is component 1 and the purple line is component 2 of the fmm. 
-- Open the overall histogram and density by country files and identify what looks reasonable while checking the FMM solutions.   
-- **FMM Strategy: Run the FMM ten times with no initial values for mu or sigma to check consistency. If inconsistent, go with model with higher Loglik or the one that looks more like positive and negative rather than the two country populations and put in the parameters for both mu and sigma from that model, this will cause the solution to be the same every time in the future. If that does not cause consistency, also put in lambda from model results and that will do it. Also, if the multiple solutions for the FMM do not match what looks right based on the histograms of the overall data and country density plots, can try to put in initial values for BOTH mu and sigma (and maybe lambda) and see if this helps find an alternative solution. **   
-- Check the probability classification plot and put in the end points for the uniroot function so that it covers the transition above 0.9 one time. Note down at the top of the code for that antigen if either positive or negative never reaches a probability of 0.9.  
-- Plot histograms showing all data, cutoffs (positive and negative), and normal distribution curves for FMM components.  
  
   
1 - X800E2A - good candidate for negative FMM population + 3SD, or UK population + 3SD, negative probability never above 0.9.  
```{r}
i = 1
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, mu = c(-1.517397, 0.196742), sigma = c(0.516787, 1.365747), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-4,-1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(-1,0),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)
}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```



2 - X800E2C
```{r}
i = 2
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), mu = c(-1.3,.8), sigma = c(0.813028, 0.797697), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-2,1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(-1,3),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

3 - X800E2D
```{r}
i = 3
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, mu = c(-0.564083, 1.435319), sigma = c(1.044024, 0.969998),fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-4,0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.6))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```



4 - X800PRISM - the negative never reaches probability above 0.9
```{r}
i = 4
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5),mu = c(-1.520649,0.611313), sigma = c(0.747110, 0.986087), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-4,0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(-1,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.6))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


5 - Ascaris
```{r}
i = 5
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2,mu = c(4.406267,2.598272), sigma = c(0.797413, 1.034637), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-1,4),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(3,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

6 - BP.FHA
```{r}
i = 6
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, mu = c(3.697882, 5.265963), sigma = c(1.518228, 0.847783), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-2,4),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
#cutoff2<-uniroot(f2,c(3,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
#multcutoffs[i,3] <- cutoff2

#percentage positive 
#pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
#multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
#abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

7 - BP.T - negative probability never above 0.9
```{r}
i = 7
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-4,0.5),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,3),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.6))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

8 - BP.Whole.Cell
```{r}
i = 8
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(2,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


9 - CMV.GradeIII
```{r}
i = 9
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(2,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


10 - CMV.pp150 
```{r}
i = 10
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0.5,4),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

11 - DT - with k = 2, negative population never reaches probability 0.9. Running as k=3 as well, and then negative population does reach probability of 0.9. Using k=3 model, but only the first two components to determine seropositivity.
```{r}
i = 11
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 3,mu = c(0.0650418, 2.148011, 4.771847), sigma= c(0.3470425, 1.040579, 1.409197), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-0.1,-0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0.5,4),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
lines(antibody1,fit.ab2$posterior[,3],lwd=2,col='red')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[3], fit.ab2$sigma[3]), add=TRUE, col="blue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


12 - DT.NIBSC
```{r}
i = 12
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(2,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

13 - EBV.EBNA.1 - don't think FMM working that well, perhaps add to the positive one population list
```{r}
i = 13
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,5),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(5,10),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

14 - EBV.VCA.P18
```{r}
i = 14
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,4),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(4,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

15 - EBV.Whole - negative probability never reaches 0.9, also this antigen did not really work and have better antigens above, will probably remove from analysis
```{r}
i = 15
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-2,0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,2),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,2.4))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}
```

16 - Etramp.4.Ag.2 - fmm did work well but may be better using PHE as negs for malarial antigens, same problem happening as above where looks like FMM picking out the two country populations rather than seropositive and seronegative
```{r}
i = 16
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-2,1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

17 - EXP3 - negative never reaches probability 0.9; country distrubutions match FMM results; maybe use UK population as negatives.

```{r}
i = 17
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-4,0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,4),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

18 - HBV.sAg - negative population never reaches probability 0.9. Tried with k=3 and had the same problem where either negative population or probability of being in second population never reached 0.9. sticking with k=2 for simplicity.
```{r}
i = 18
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, k = 2,lambda = c(0.5,0.5), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-6,.8),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)
}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

19 - HSV1 - negative population never reaches 0.9 ; could possible be three populations. 
```{r}
i = 19
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, mu = c(-0.0709852, 1.257015), sigma = c(0.1537635, 0.589298),fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-0.5,0.2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,1))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

20 - HSV2 - negative population never reaches probability 0.9
```{r}
i = 20
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

#this time, both different FMM solutions were not matching the negative and positive populations I see from my country and overall histograms, but when I put in mu = c(0,1), sigma = c(0.2,0.5) I was able to get a solution that matches those populations. 
fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, mu = c(0.0279830, 1.050985), sigma = c(0.1023426, 0.619804), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-1,0.5),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,2),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,1.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


21 - Influenza.B - negative population never reaches probability of 0.9
```{r}
i = 21
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2,mu = c(1.886046, 3.720201), sigma = c(0.801257, 0.657361), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(-1,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(2,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)

```

22 - Meningococcal.Y - works well as two populations but looks like could also work well as three
```{r}
i = 22
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,9), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

23 - MSP1.19 - the plot looks like may be 3 populations but doesn't make sense based on the UK density plot. Once again, malarial antigen, may be better to use UK as negatives and do mean +/- 3SD.
```{r}
i = 23
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

#FMM had several solutions and sometimes did not converge. To select a solution, had to put in lambda, mu, and sigma!!
fit.ab2<-normalmixEM(antibody1, lambda =c(0.194031, 0.805969), k = 2,mu = c(5.031505, 0.973021),sigma=c(1.582342, 1.859804), fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,4),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

24 - MSP2.CH150.9 - negative population never reaches probability of 0.9.
```{r}
i=24
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

#FMM had several solutions and sometimes did not converge. To select a solution, had to put in lambda, mu, and sigma!!
fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(0,4),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,2),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

25 - MSP2.Dd2 - negative population never reaches probability 0.9.
```{r}
i=25
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

#FMM had several solutions and sometimes did not converge. To select a solution, had to put in lambda, mu, and sigma!!
fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(0,4),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(-1,1),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
#abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


26 - Mtb.Acr.HspX.
```{r}
i = 26
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

#FMM had several solutions and sometimes did not converge. To select a solution, had to put in lambda, mu, and sigma!!
fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0.1,1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,1))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```
27 - Mtb.Ag85B
```{r}
i = 27
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,1))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```
28 - Mtb.CFP10.ESAT.6 - negative population never reaches probability of 0.9.
```{r}
i = 28
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-2,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,10), ylim = c(0,0.7))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

29 - PHISTC.B - negative population never reaches probability of 0.9
```{r}
i = 29
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-4,0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,4),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,9), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

30 - Pneumococcal.14 - positive population never reaches probability of 0.9. looks like one positive population from original histogram - need to read more about expected prevalence before any attempts to repeat this. Came up with same solution 11 times but taking almost 10,000 iterations every time which is very unusual.
```{r}
i = 30
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(2,5),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
#cutoff2<-uniroot(f2,c(1,8),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
#multcutoffs[i,3] <- cutoff2

#percentage positive 
#pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
#multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
#abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

31 - Pneumococcal.18C
```{r}
i = 31
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.288671, 0.711329),mu = c(2.406266, 4.069546),
sigma = c(1.046207, 1.011170), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,2),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(2,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

32 - Pneumococcal.19A
```{r}
i = 32
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), mu = c(2.332470, 4.162575),
sigma = c(1.007309, 0.858274), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(3,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

33 - Pneumococcal.33F
```{r}
i = 33
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(3,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


34 - Poliovirus - negative population never reaches probability 0.9. Also, I tried to input values of mu ~ 1 and 2.2, with a range of sigma and lambda, but that forced the solution to the one I had previously selected of the 3 the FMM was giving without initial values specified.
```{r}
i = 34
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.0662692, 0.933731), 
mu = c(0.8811338, 1.812612), sigma= c(0.3076632, 0.666435), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(0,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,3),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,1.2))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

35 - Rh2_2030 - negative population never reaches probability 0.9. It gets really close though, the maximum posterior probability is 0.8963356. :(
```{r}
i = 35
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-5,0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(-1,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.8))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

36 - Rotavirus, k = 3, negative population never reaches probability of 0.9. Tried as k=2 also and that is giving completely different results (means ~ 3 and 5, but there is a 0.9 probability for both negative and positive populations). A decision of which model to use may follow lit review of expected response to this antigen/pathogen. 
```{r}
i = 36
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda = c(0.043028, 0.413406, 0.543566),
mu = c(0.935718, 3.074852, 4.946468), sigma = c(0.373065, 0.931418, 0.731272), k = 3, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(-0.1,-0),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,2),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
lines(antibody1,fit.ab2$posterior[,3],lwd=2,col='red')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[3], fit.ab2$sigma[3]), add=TRUE, col="blue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

37 - Rub.GradeIV, k = 3
```{r}
i = 37
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda= c(0.0580826, 0.408354, 0.533564),
mu= c(0.0245695, 3.662323, 5.468398), sigma = c(0.2678195, 1.219799, 0.606957), k = 3, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,2),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
lines(antibody1,fit.ab2$posterior[,3],lwd=2,col='red')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-4,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[3], fit.ab2$sigma[3]), add=TRUE, col="blue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


38 - Tg
```{r}
i = 38
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,10), ylim = c(0,0.8))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

39 - Tg.GradeIII
```{r}
i = 39
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,1),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(1,6),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,10), ylim = c(0,1))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```

40 - TT
```{r}
i = 40
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
cutoff<-uniroot(f,c(0,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(2,7),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,10), ylim = c(0,0.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,2:3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


41 - VZV.GradeIII - negative population never reaches probability of 0.9. Looks like could be a candidate for one population only (possible, depending on the background epi knowledge)
```{r}
i = 41
#Select antigen
antigen <- multantnames[i]
antigen

#subset data for this antigen
singleant <- c(as.matrix(multants[i, (ncol(targetupdate)+1):ncol(multants)]))
#singleant <- singleant[singleant >= 0]

#put the data in numerical order - required to generate probability classification plot below
antibody1 <- sort(singleant)

#### Try FMM model first

fit.ab2<-normalmixEM(antibody1, lambda =c(0.5, 0.5), k = 2, fast=FALSE,maxit=10000,epsilon = 1e-16,maxrestarts=1000)

#5 Plot Cut off Value
summary(fit.ab2)

#cutoff below which is negative - manually set interval end points
#cutoff<-uniroot(f,c(0,3),prob=0.90,lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=1)$root

#cutoff above which is positive - manually set interval end points
cutoff2<-uniroot(f2,c(0,2),prob=0.90, lambda=fit.ab2$lambda,mu=fit.ab2$mu,sigma=fit.ab2$sigma,k=2,k1=2)$root

#multcutoffs[i,2] <- cutoff
multcutoffs[i,3] <- cutoff2

#percentage positive 
pos <- sum(antibody1>cutoff2)/length(antibody1) * 100

#percentage negative
#neg <- sum(antibody1<cutoff)/length(antibody1) * 100

#percentage indeterminate
#indet <- (1-sum(antibody1>cutoff2)/length(antibody1)-sum(antibody1<cutoff)/length(antibody1)) *100

#multcutoffs[i,4] <- neg
multcutoffs[i,5] <- pos
#multcutoffs[i,6] <- indet

#Plot cutoffs if there are two
{plot(antibody1,fit.ab2$posterior[,1],type='n',xlim=c(-4,10),lwd=2,ylim=c(0,1),col='green',las=1,xlab='Log2(MFI Ratio)',ylab='classification probability', main = paste(antigen, "FMM"))

#rect(cutoff,-0.04,cutoff2,1.04,col='light grey',lwd=1.5)
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='red')

abline(h=0.90,lwd=1.5,lty=2)
#abline(v=cutoff,lwd=1)
abline(v=cutoff2,lwd=1)

lines(antibody1,fit.ab2$posterior[,1],lwd=2,col='blue')
lines(antibody1,fit.ab2$posterior[,2],lwd=2,col='purple')
legend(1125,0.8,c(expression(S^'-'),expression(S^'+')),lty=c(1,1),lwd=2,col=c('blue','purple'))}

#Plot histogram with cutoffs shown and normal distributions shown
{hist(antibody1, prob = TRUE, breaks=50, main = paste(antigen, "FMM"), 
  xlab="Normalized Log2(MFI Ratio)", cex.main=0.9, cex.lab=0.8, 
  cex.axis = 0.8, xlim=c(-2,8), ylim = c(0,1.5))
curve(dnorm(x, fit.ab2$mu[1], fit.ab2$sigma[1]), add=TRUE, col="darkblue", lwd=2)
curve(dnorm(x, fit.ab2$mu[2], fit.ab2$sigma[2]), add=TRUE, col="darkblue", lwd=2)
abline(v = multcutoffs[i,3], col = "red", lty = 2, lwd = 0.7, xpd=FALSE)}

remove(antigen, antibody1, cutoff, cutoff2, neg, pos, indet, fit.ab2)
```


5. Save the cutoff/prevalence data frame as an r object and export as a .csv file. 
```{r}
#Display all of the cutoffs and prevalences
multcutoffs

#save the cutoffs in an R object to be imported later 
save(multcutoffs, file=paste0(study,"_multcutoffs"))

#save the cutoffs as .csv file too just in case
write.csv(multcutoffs, file=paste0(study,"_multcutoffs.csv"))


```
